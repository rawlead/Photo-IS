<!doctype html>
<html lang="en">
<head th:include="fragments/header :: head('Photos')"></head>
<body>
<header th:replace="fragments/header :: header">TOP NAVIGATION</header>
<div class="container-fluid" id="categoriesRoot">

    <div class="row hor-sep-60"></div>

    <ul th:replace="fragments/nav :: leftNav">LEFT SIDE NAVIGATION</ul>

    <div class="hor-sep-30"></div>

    <!-- Modal -->
    <div class="modal fade user-photo-modal" tabindex="-1" role="dialog"
         aria-labelledby="user-photo-modal" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content" style=" border: none">

                <h5 style="left: 5px;" v-if="modalPhoto.user">
                    <a v-bind:href="'/profile/' + modalPhoto.user.username" class="badge badge-dark">
                        <img src="" v-bind:src="modalPhoto.user.avatarUrl" alt=""/>
                        @{{modalPhoto.user.username}}</a>
                </h5>

                <h5 style="right: 5px;" v-if="modalPhoto.photoCategory">
                    <a style="color: white;" class="badge badge-dark"><i class="fas fa-clipboard-list"></i>
                        {{modalPhoto.photoCategory.name}}</a>
                </h5>
                <a v-bind:href="'/photo/' + modalPhoto.id">

                    <img v-bind:src="modalPhoto.url" alt=""/>
                </a>
                <div class="modal-footer">
                    <div class="row">
                        <div class="col-md-12">
                            <div v-show="modalPhoto.title"><p><b>{{modalPhoto.title}}</b></p></div>
                            <div v-show="modalPhoto.description"><p>{{modalPhoto.description}}</p></div>
                            <a v-bind:href="'/photo/' + modalPhoto.id" class="btn btn-outline-success"><i
                                    class="fas fa-comment"></i> Comments ({{commentCounter}})</a>
                            <a v-if="!isPhotoFavorite" v-on:click="isPhotoFavorite = !isPhotoFavorite;"
                               onclick="addPhotoToFavoritesRequest(photosPage.loggedInUser, photosPage.modalPhoto, photosPage)"
                               class="btn btn-outline-dark" href="#"><i class="fas fa-star"></i> Favorite</a>
                            <a v-else-if="isPhotoFavorite" v-on:click="isPhotoFavorite = !isPhotoFavorite;"
                               onclick="removePhotoFromFavoritesRequest(photosPage.loggedInUser, photosPage.modalPhoto, photosPage)"
                               class="btn btn-outline-dark" href="#"><i class="far fa-star"></i> Remove</a>


                            <button disabled="disabled" class=" btn btn-outline-dark" v-if="modalPhoto.dateCreated"><i
                                    class="fas fa-calendar-alt"></i> {{modalPhoto.dateCreated}}
                            </button>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <div class="row">
        <div class="col-md-10 offset-md-2">
            <p v-for="category in categories">{{category.name}}</p>
            <div class="photos-container row">
                <div v-for="photo in photos" class="photo-grid-item" v-on:click="openModalPhoto(photo)">
                    <img v-bind:src="photo.url"
                         class="grid-image openImageDialog"
                         alt=""/>
                    <div class="middle">
                        <h5><b>{{photo.title}}</b></h5>
                    </div>
                </div>
            </div>


        </div>
    </div>
</div>
<div th:replace="fragments/footer :: scripts"></div>
<script>

    loadProgressBar();

    var photosPage = new Vue({
        el: '#categoriesRoot',
        data: {
            categories: '',
            photos: [],
            modalPhoto: '',
            commentCounter: 0,
            isPhotoFavorite: false,
            favoritePhotos: [],
            loggedInUser:''


        },
        mounted() {
            this.fetchLoggedInUser();
            this.fetchAllPhotos();
            this.fetchCategories();
        },

        methods: {
            fetchLoggedInUser() {
                if (getCookie("access_token")) {
                    getLoggedInUserRequest()
                        .then(function (response) {
                            this.loggedInUser = response.data;
                            this.fetchFavoritePhotos();
                        }.bind(this))
                        .catch(function (error) {
                            deleteCookie("access_token");
                            return error;
                        });
                }
            },
            fetchCategories() {
                getCategoriesRequest()
                    .then(function (response) {
                        this.categories = response.data
                    }.bind(this)).catch(function (errors) {
                    console.log(errors)
                });
            },
            fetchAllPhotos() {
                getAllPhotosRequest()
                    .then(function (response) {
                        this.photos = response.data;
                    }.bind(this)).catch(function (errors) {
                    console.log(errors)
                })
            },
            openModalPhoto(photo) {
                this.modalPhoto = photo;
                this.fetchIsPhotoFavorite(photo);
                this.fetchCommentsToPhoto(photo);
                $('.user-photo-modal').modal('show')
            },
            fetchFavoritePhotos() {
                getFavoritePhotosRequest(this.loggedInUser)
                    .then(function (response) {
                        this.favoritePhotos = response.data;
                    }.bind(this))
                    .catch(function (error) {
                        console.log(error)
                    });
            },
            fetchIsPhotoFavorite(photo) {
                this.isPhotoFavorite = this.favoritePhotos.some(e => e.id === photo.id);
            },
            fetchCommentsToPhoto(photo) {
                getCommentsToPhotoRequest(photo.id)
                    .then(function (response) {
                        this.commentCounter = response.data.length;
                    }.bind(this))
            }
        }

    })
</script>
</body>
</html>